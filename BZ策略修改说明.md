# BZ策略维度缩放修复方案

## 问题分析

从日志中可以看到，BZ策略存在维度误差不平衡的问题：

```
维度 0: 误差 = 281.529999  (pressure)
维度 1: 误差 = 1.273253    (wall-shear)
维度 2: 误差 = 0.484378    (x-wall-shear)
维度 3: 误差 = 0.204999    (y-wall-shear)
维度 4: 误差 = 0.544602    (z-wall-shear)
```

**问题**：
- pressure维度误差比其他维度大200-1000倍
- 导致BZ策略几乎完全由pressure误差主导（占99.1%）
- 忽略了其他物理量的误差贡献
- 可能错过在其他维度上误差较大的重要样本

## 解决方案

### 1. 自适应维度缩放 (`bz_scaled`)

**原理**：根据数据分布自动计算各维度的缩放因子

**优点**：
- 完全自动化，无需手动调参
- 根据实际数据分布平衡各维度贡献
- pressure误差占比降至约20%

**使用方法**：
```python
strategy = 'bz_scaled'
```

### 2. 手动权重设置 (`bz_manual`)

**原理**：手动设置各维度权重来平衡影响

**当前权重**：`[0.1, 1.0, 1.0, 1.0, 1.0]`
- pressure权重降至0.1
- 其他维度保持1.0

**优点**：
- 可精确控制各维度影响
- 适合已知特定维度主导的情况

**使用方法**：
```python
strategy = 'bz_manual'
```

### 3. 等权重方案 (`scaling_method='equal'`)

**原理**：所有维度使用相同权重

**适用场景**：作为基准对比

## 文件说明

### 新增文件

1. **`bz_strategy_scale_fix.py`** - 核心实现
   - `bz_query_with_dimension_scaling()` - 主要函数
   - `calculate_dimension_scales()` - 自适应缩放计算
   - `compare_scaling_methods()` - 方法比较

2. **`analyze_dimension_errors.py`** - 分析脚本
   - 分析各维度数据分布
   - 模拟缩放效果
   - 生成权重建议

3. **`test_bz_scaling.py`** - 测试脚本
   - 比较不同策略效果
   - 生成可视化图表
   - 分析样本特征

4. **`bz_usage_guide.py`** - 使用指南
   - 详细使用说明
   - 快速测试脚本生成

### 修改文件

1. **`albz.py`** - 主动学习脚本
   - 添加了三种BZ策略选项
   - 默认策略改为 `bz_scaled`

## 使用指南

### 快速开始

1. **运行缩放版BZ策略**：
   ```bash
   python albz.py
   ```
   （默认使用 `bz_scaled` 策略）

2. **切换策略**：
   编辑 `albz.py` 中的策略设置：
   ```python
   strategy = 'bz_scaled'  # 自适应缩放（推荐）
   # strategy = 'bz_manual'  # 手动权重
   # strategy = 'bz'         # 原始策略（对比用）
   ```

3. **查看效果**：
   检查 `round_log.txt` 中的维度误差分布是否更平衡

### 高级使用

1. **自定义权重**：
   修改 `bz_strategy_scale_fix.py` 中的 `manual_weights`：
   ```python
   manual_weights = [0.05, 1.0, 1.0, 1.0, 1.0]  # 进一步降低pressure权重
   ```

2. **分析数据分布**：
   ```bash
   python analyze_dimension_errors.py
   ```

3. **测试对比**：
   ```bash
   python test_bz_scaling.py
   ```

4. **快速测试**：
   ```bash
   python bz_usage_guide.py  # 生成测试脚本
   python quick_test_bz.py   # 运行测试
   ```

## 预期效果

### 误差分布对比

| 方法 | pressure占比 | 其他维度影响 | 效果 |
|------|-------------|-------------|------|
| 原始BZ | 99.1% | 几乎忽略 | 严重失衡 |
| 归一化缩放 | 20.0% | 均衡 | **推荐** |
| 手动权重 | 91.8% | 有限改善 | 可用 |
| 平方根缩放 | 84.8% | 部分改善 | 可选 |

### 样本选择改善

- **原始策略**：几乎只考虑pressure误差，样本选择单一
- **缩放策略**：综合考虑所有维度，样本选择更多样化
- **预期结果**：可能发现在wall-shear等其他物理量上误差较大的重要样本

## 理论依据

### 1. 多目标优化
将单一误差目标转换为多维度平衡的目标函数

### 2. 特征缩放
类似机器学习中的特征标准化，避免大数值特征主导

### 3. 主动学习理论
选择在所有维度上都具有学习价值的样本，而非仅在单一维度

## 验证方法

1. **日志对比**：观察选择样本的维度误差分布
2. **样本多样性**：检查选择样本的物理参数分布
3. **学习效果**：比较不同策略下的模型收敛性能
4. **可视化分析**：使用测试脚本生成的图表

## 后续优化

1. **动态权重**：根据训练进展动态调整维度权重
2. **物理约束**：结合物理知识设计更合理的权重
3. **不确定性量化**：考虑预测不确定性的维度分布
4. **多模型集成**：使用多个模型的预测差异

---

**总结**：通过维度缩放，BZ策略可以更好地平衡各物理量的误差贡献，避免单一维度主导的问题，提高主动学习的样本选择质量。
